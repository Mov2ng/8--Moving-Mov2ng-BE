name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. Prisma generate
      - name: Prisma generate
        run: npx prisma generate

      # 5. Build
      - name: Build
        run: npm run build

      # 6. ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      - name: Archive build
        run: |
          mkdir deploy
          cp -r dist prisma package.json ecosystem.config.js deploy/
          tar -czf deploy.tar.gz deploy

      # 7. EC2ë¡œ íŒŒì¼ ì „ì†¡
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: deploy.tar.gz
          target: /home/ec2-user/8--Moving-Mov2ng-BE

      # 8. EC2 ë°°í¬ ì‹¤í–‰
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            APP_DIR=/home/ec2-user/8--Moving-Mov2ng-BE
            RELEASE_DIR=$APP_DIR/releases/$(date +%Y%m%d-%H%M%S)

            mkdir -p $RELEASE_DIR
            tar -xzf $APP_DIR/deploy.tar.gz -C $RELEASE_DIR
            rm $APP_DIR/deploy.tar.gz

            ln -sfn $RELEASE_DIR $APP_DIR/current

            cd $APP_DIR/current/deploy
            npm install --production

            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

      # 9. âœ… ì„±ê³µ ì•Œë¦¼
      - name: Discord Notify (Success)
        if: success()
        uses: Ilshidur/action-discord@v2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            ğŸš€ **ë°°í¬ ì„±ê³µ**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ”– Commit: `${{ github.sha }}`
            ğŸ‘¤ By: ${{ github.actor }}

      # 10. âŒ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notify (Failure)
        if: failure()
        uses: Ilshidur/action-discord@v2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            âŒ **ë°°í¬ ì‹¤íŒ¨**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ By: ${{ github.actor }}
            ğŸ§¨ Check GitHub Actions logs
