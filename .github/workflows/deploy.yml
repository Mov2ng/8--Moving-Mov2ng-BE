name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. Prisma generate (DB ì—°ê²° ì—†ì´ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë§Œ ìƒì„±)
      - name: Prisma generate
        run: npx prisma generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

      # 5. Build
      - name: Build
        run: npm run build
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          JWT_SECRET: "dummy-jwt-secret-for-build"
          AWS_REGION: "ap-northeast-2"
          AWS_ACCESS_KEY_ID: "dummy"
          AWS_SECRET_ACCESS_KEY: "dummy"
          AWS_S3_BUCKET_NAME: "dummy"

      # 6. ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      - name: Archive build
        run: |
          mkdir deploy
          cp -r dist prisma package.json package-lock.json ecosystem.config.js prisma.config.ts deploy/
          tar -czf deploy.tar.gz deploy

      # 7. EC2ë¡œ íŒŒì¼ ì „ì†¡
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: deploy.tar.gz
          target: /home/ec2-user/8--Moving-Mov2ng-BE

      # 8. EC2 ë°°í¬ ì‹¤í–‰
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            APP_DIR=/home/ec2-user/8--Moving-Mov2ng-BE
            RELEASE_DIR=$APP_DIR/releases/$(date +%Y%m%d-%H%M%S)

            # ì••ì¶• í•´ì œ
            mkdir -p $RELEASE_DIR
            tar -xzf $APP_DIR/deploy.tar.gz -C $RELEASE_DIR
            rm $APP_DIR/deploy.tar.gz

            # í˜„ì¬ ë¦´ë¦¬ìŠ¤ë¡œ ì‹¬ë³¼ë¦­ ë§í¬ ì—…ë°ì´íŠ¸
            ln -sfn $RELEASE_DIR/deploy $APP_DIR/current

            cd $APP_DIR/current

            # .env íŒŒì¼ ì‹¬ë³¼ë¦­ ë§í¬ (APP_DIR/.env íŒŒì¼ í•„ìš”)
            ln -sf $APP_DIR/.env .env

            # ì˜ì¡´ì„± ì„¤ì¹˜ (prisma CLI í•„ìš”í•˜ë¯€ë¡œ ì „ì²´ ì„¤ì¹˜ í›„ ì •ë¦¬)
            npm ci
            
            # Prisma client ìƒì„± ë° ë§ˆì´ê·¸ë ˆì´ì…˜
            npx prisma generate
            npx prisma migrate deploy
            
            # devDependencies ì œê±°
            npm prune --production

            # PM2 ì¬ì‹œì‘
            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

            # ì˜¤ë˜ëœ ë¦´ë¦¬ìŠ¤ ì •ë¦¬ (ìµœê·¼ 5ê°œë§Œ ìœ ì§€)
            cd $APP_DIR/releases && ls -t | tail -n +6 | xargs -r rm -rf

      # 9. âœ… ì„±ê³µ ì•Œë¦¼
      - name: Discord Notify (Success)
        if: success()
        uses: Ilshidur/action-discord@0.3.2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            ğŸš€ **ë°°í¬ ì„±ê³µ**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ”– Commit: `${{ github.sha }}`
            ğŸ‘¤ By: ${{ github.actor }}

      # 10. âŒ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notify (Failure)
        if: failure()
        uses: Ilshidur/action-discord@0.3.2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            âŒ **ë°°í¬ ì‹¤íŒ¨**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ By: ${{ github.actor }}
            ğŸ§¨ Check GitHub Actions logs
