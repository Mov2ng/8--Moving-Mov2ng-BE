name: Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. EC2 ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /home/ec2-user/8--Moving-Mov2ng-BE

            echo "ğŸ“¦ Pull latest code"
            git pull origin main

            echo "ğŸ“¦ Install dependencies"
            npm install

            echo "ğŸ§¬ Prisma generate"
            npx prisma generate

            echo "ğŸ— Build"
            npm run build

            echo "â™»ï¸ Restart PM2"
            pm2 reload all --update-env

      # âœ… ì„±ê³µ ì•Œë¦¼
      - name: Discord Success Notification
        if: success()
        uses: appleboy/discord-action@v0.3.2
        with:
          webhook_id: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            âœ… **Deploy Success**
            - Repository: `${{ github.repository }}`
            - Branch: `${{ github.ref_name }}`
            - Commit: `${{ github.sha }}`
            - Actor: `${{ github.actor }}`

      # âŒ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Failure Notification
        if: failure()
        uses: appleboy/discord-action@v0.3.2
        with:
          webhook_id: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            âŒ **Deploy Failed**
            - Repository: `${{ github.repository }}`
            - Branch: `${{ github.ref_name }}`
            - Actor: `${{ github.actor }}`
            - Workflow: `${{ github.workflow }}`
